/*!
* jQuery appendGrid v1.0.0
* https://appendgrid.apphb.com/
*
* Copyright 2013 Albert L.
* Dual licensed under the GPL (http://www.gnu.org/licenses/gpl.html)
* and MIT (http://www.opensource.org/licenses/mit-license.php) licenses.
*
* Depends:
* jQuery v1.9.1+
* jquery UI v1.10.2+
*/
(function(e){var m={caption:null,initRows:3,initData:null,firstCellWidth:32,lastCellWidth:89,columns:null,i18n:null,idPrefix:null,dataLoaded:null,afterRowAppended:null,afterRowInserted:null,afterRowSwapped:null,beforeRowRemove:null,afterRowRemoved:null,_uniqueIndex:0,_rowOrder:null,_isDataLoaded:false,_visibleCount:0};var o={type:"text",name:null,value:null,display:null,displayCss:null,cellCss:null,ctrlAttr:null,ctrlCss:null,ctrlClass:null,ctrlOptions:null,uiOption:null,uiTooltip:null,customBuilder:null,customGetter:null,customSetter:null,onClick:null,onChange:null};var j={append:"Append Row",removeLast:"Remove Last Row",insert:"Insert Row Above",remove:"Remove Current Row",moveUp:"Move Up",moveDown:"Move Down"};var i={init:function(D){var A=this;var y,s,C,u,w,t;if(A.length>0){if(!e.isArray(D.columns)||D.columns.length==0){alert("Cannot initial grid without column information!");return A}y=A[0];if(k(y.tagName)||y.tagName!="TABLE"){alert("Cannot initial grid on element other than TABLE!");return A}var v=e.extend({},m,D);if(e.isPlainObject(D.textResources)){v.textResources=e.extend({},j)}else{v.textResources=e.extend({},j,D.textResources)}v._rowOrder=[];if(k(v.idPrefix)){if(k(y.id)||y.id==""){v.idPrefix="ag"+new Date().getTime()}else{v.idPrefix=y.id}}s=document.createElement("thead");s.className="ui-widget-header";C=document.createElement("tbody");C.className="ui-widget-content";u=document.createElement("tfoot");u.className="ui-widget-header";e(y).empty().addClass("appendGrid").addClass("ui-widget").append(s,C,u);v._visibleCount=0;w=s.insertRow(-1);t=w.insertCell(-1);t.className="ui-widget-header";e(t).width(v.firstCellWidth);for(var B=0;B<v.columns.length;B++){var x=e.extend({},o,v.columns[B]);v.columns[B]=x;if(v.columns[B].type!="hidden"){v._visibleCount++;t=w.insertCell(-1);t.className="ui-widget-header";e(t).text(v.columns[B].display);if(v.columns[B].displayCss){e(t).css(v.columns[B].displayCss)}}}t=w.insertCell(-1);t.className="ui-widget-header";e(t).width(v.lastCellWidth);if(v.caption){w=s.insertRow(0);t=w.insertCell(-1);t.className="ui-state-active caption";t.colSpan=v._visibleCount+2;e(t).text(v.caption)}w=u.insertRow(-1);t=w.insertCell(-1);t.colSpan=v._visibleCount+2;e(t).append(e("<input/>").attr({type:"hidden",id:v.idPrefix+"_rowOrder",name:v.idPrefix+"_rowOrder"}).addClass("row-order"));e(t).append(e("<button/>").attr({type:"button",title:v.textResources.append}).button({icons:{primary:"ui-icon-plusthick"},text:false}).click(function(){d(y,1,null,null)}));e(t).append(e("<button/>").attr({type:"button",title:v.textResources.removeLast}).button({icons:{primary:"ui-icon-closethick"},text:false}).click(function(){g(y,null,this.value,false)}));e(y).data("appendGrid",v);if(e.isArray(D.initData)){a(y,D.initData,true)}else{e(y).appendGrid("appendRow",v.initRows)}}return A},isReady:function(){var u=this,s=false;if(u.length>0){var t=u.first().data("appendGrid");if(t){s=true}}return s},isDataLoaded:function(){var u=this,s=null;if(this.length==1){var t=u.data("appendGrid");if(t){return t._isDataLoaded}else{return false}}else{return false}},load:function(s){var t=this;if(t.length>0){a(t[0],s,false)}return t},appendRow:function(s){return this.appendGrid("insertRow",s)},insertRow:function(v,z,t){var y=this;if(y.length>0){var s=y[0],x=null;var w=e(s).data("appendGrid");if(!w){alert("`appendGrid` does not initialized")}else{x=d(s,v||1,z,t);if(e.isNumeric(z)||e.isNumeric(t)){n(s,x.rowIndex);var u=w._rowOrder[x.addedRows[0]];e("#"+w.idPrefix+"_Insert_"+u,s).focus()}}}return y},removeRow:function(y,x){var w=this,z=-1;if(w.length>0){var v=w[0],s,A,u;var t=e(v).data("appendGrid");if(!t){alert("`appendGrid` does not initialized")}else{if(t._rowOrder.length>0){g(v,y,x,true)}}}return w},moveUpRow:function(y,x){var w=this,z=-1;if(w.length>0){var v=w[0],C,B,s,u;var t=e(v).data("appendGrid");if(!t){alert("`appendGrid` does not initialized")}else{var A=null;C=v.getElementsByTagName("tbody")[0];if(e.isNumeric(y)&&y>0&&y<t._rowOrder.length){A=y;x=t._rowOrder[y];B=document.getElementById(t.idPrefix+"_Row_"+x,v)}else{if(e.isNumeric(x)){A=f(x,t);B=document.getElementById(t.idPrefix+"_Row_"+x,v)}}if(A!=null&&A>0){s=document.getElementById(t.idPrefix+"_Row_"+t._rowOrder[A-1],v);C.removeChild(B);C.insertBefore(B,s);t._rowOrder[A]=t._rowOrder[A-1];t._rowOrder[A-1]=x;u=e("td.first",s).html();e("td.first",s).html(e("td.first",B).html());e("td.first",B).html(u);b(v,t);e("td.last button.moveUp",B).removeClass("ui-state-hover").blur();e("td.last button.moveUp",s).focus();if(t.afterRowSwapped){t.afterRowSwapped(v,A,A-1)}}}}return w},moveDownRow:function(y,x){var w=this,z=-1;if(w.length>0){var v=w[0],C,B,s,u;var t=e(v).data("appendGrid");if(!t){alert("`appendGrid` does not initialized")}else{var A=null;C=v.getElementsByTagName("tbody")[0];if(e.isNumeric(y)&&y>=0&&y<t._rowOrder.length-1){A=y;x=t._rowOrder[y];B=document.getElementById(t.idPrefix+"_Row_"+x,v)}else{if(e.isNumeric(x)){A=f(x,t);B=document.getElementById(t.idPrefix+"_Row_"+x,v)}}if(A!=null&&A!=t._rowOrder.length-1){s=document.getElementById(t.idPrefix+"_Row_"+t._rowOrder[A+1],v);C.removeChild(s);C.insertBefore(s,B);t._rowOrder[A]=t._rowOrder[A+1];t._rowOrder[A+1]=x;u=e("td.first",s).html();e("td.first",s).html(e("td.first",B).html());e("td.first",B).html(u);b(v,t);e("td.last button.moveDown",B).removeClass("ui-state-hover").blur();e("td.last button.moveDown",s).focus();if(t.afterRowSwapped){t.afterRowSwapped(v,A,A+1)}}}}return w},getRowCount:function(){var t=this;if(t.length>0){var s=t.data("appendGrid");if(s){return s._rowOrder.length}else{alert("`appendGrid` does not initialized")}}else{alert("Cannot get values on multiple grid")}return null},getUniqueIndex:function(u){var t=this;if(t.length>0&&u>=0){var s=t.data("appendGrid");if(s){if(u<s._rowOrder.length){return s._rowOrder[u]}}else{alert("`appendGrid` does not initialized")}}return null},getRowIndex:function(s){var u=this;if(u.length>0){var t=u.data("appendGrid");if(t){for(var v=0;v<t._rowOrder.length;v++){if(t._rowOrder[v]==s){return v}}return null}else{alert("`appendGrid` does not initialized")}}return null},getRowValue:function(x,t,w){var v=this,s=null;if(v.length>0){var u=v.data("appendGrid");if(u){if(e.isNumeric(x)&&x>=0&&x<u._rowOrder.length){t=u._rowOrder[x]}if(!k(t)){s=h(u,t,w)}}else{alert("`appendGrid` does not initialized")}}return s},getAllValue:function(v){var w=this,s=null,t;if(w.length>0){var u=e(w).data("appendGrid");if(u){s=v?{}:[];for(var x=0;x<u._rowOrder.length;x++){if(v){t=h(u,u._rowOrder[x],x);e.extend(s,t)}else{t=h(u,u._rowOrder[x]);s.push(t)}}if(v){s._RowCount=u._rowOrder.length}}}return s},getCtrlValue:function(s,v){var t=this;if(t.length>0){settings=t.data("appendGrid");if(settings&&v>=0&&v<settings._rowOrder.length){for(var u=0;u<settings.columns.length;u++){if(settings.columns[u].name===s){return c(settings,u,settings._rowOrder[v])}}}}return null},setCtrlValue:function(t,y,v){var w=this;if(w.length>0){var s=this,u=e(this).data("appendGrid");if(u&&y>=0&&y<u._rowOrder.length){for(var x=0;x<u.columns.length;x++){if(u.columns[x].name==t){l(u,x,u._rowOrder[y],v);break}}}}return w},getCellCtrl:function(u,t){var v=this,s=null;if(v.length==1){settings=v.data("appendGrid");if(!settings){alert("`appendGrid` does not initialized")}else{for(var w=0;w<settings.columns.length;w++){if(settings.columns[w].name===u){return p(settings.columns[w].type,settings.idPrefix,u,t);break}}}}return null},getCellCtrlByRowIndex:function(u,x){var v=this,s=null;if(v.length==1){settings=v.data("appendGrid");if(!settings){alert("`appendGrid` does not initialized")}else{if(x>=0&&x<settings._rowOrder.length){var t=settings._rowOrder[x];for(var w=0;w<settings.columns.length;w++){if(settings.columns[w].name===u){return p(settings.columns[w].type,settings.idPrefix,u,t)}}}}}return null},setCellCtrlByRowIndex:function(u,y,v){var w=this,s=null;if(w.length==1){settings=w.data("appendGrid");if(!settings){alert("`appendGrid` does not initialized")}else{if(y>=0&&y<settings._rowOrder.length){var t=settings._rowOrder[y];for(var x=0;x<settings.columns.length;x++){if(settings.columns[x].name===u){return setCellCtrl(settings.columns[x].type,settings.idPrefix,u,t,v)}}}}}return null},getRowOrder:function(){var u=this,s=null;if(this.length==1){var t=u.data("appendGrid");if(t){s=t._rowOrder.slice()}else{alert("`appendGrid` does not initialized")}}else{alert("Cannot get values on multiple grid")}return s}};function d(A,I,G,B){var u=e(A).data("appendGrid");var L=[],v=null,D,s,w=[];var t=A.getElementsByTagName("thead")[0];var K=A.getElementsByTagName("tbody")[0];if(e.isNumeric(B)){for(var E=0;E<u._rowOrder.length;E++){if(u._rowOrder[E]==B){G=E;if(E!=0){v=E-1}break}}}else{if(e.isNumeric(G)){if(G>=u._rowOrder.length){G=null}else{v=G-1}}else{if(u._rowOrder.length!=0){G=null;v=u._rowOrder.length-1}}}for(var E=0;E<I;E++){u._uniqueIndex++;D=u._uniqueIndex;w.length=0;if(e.isNumeric(G)){u._rowOrder.splice(G,0,D);tbRow=K.insertRow(G);L.push(G)}else{u._rowOrder.push(D);tbRow=K.insertRow(-1);L.push(u._rowOrder.length-1)}tbRow.id=u.idPrefix+"_Row_"+D;tbCell=tbRow.insertCell(-1);e(tbCell).addClass("ui-widget-content first").text(u._rowOrder.length).data("appendGrid",D);for(var F=0;F<u.columns.length;F++){if(u.columns[F].type=="hidden"){w.push(F);continue}tbCell=tbRow.insertCell(-1);tbCell.className="ui-widget-content";if(u.columns[F].cellCss!=null){e(tbCell).css(u.columns[F].cellCss)}s=null;if(u.columns[F].type=="custom"){if(typeof(u.columns[F].customBuilder)=="function"){s=u.columns[F].customBuilder(tbCell,u.idPrefix,u.columns[F].name,D)}}else{if(u.columns[F].type=="select"){s=document.createElement("select");s.id=u.idPrefix+"_"+u.columns[F].name+"_"+D;s.name=s.id;if(e.isArray(u.columns[F].ctrlOptions)){if(u.columns[F].ctrlOptions.length>0){if(e.isPlainObject(u.columns[F].ctrlOptions[0])){for(var H=0;H<u.columns[F].ctrlOptions.length;H++){s.options[s.options.length]=new Option(u.columns[F].ctrlOptions[H].label,u.columns[F].ctrlOptions[H].value)}}else{for(var H=0;H<u.columns[F].ctrlOptions.length;H++){s.options[s.options.length]=new Option(u.columns[F].ctrlOptions[H],u.columns[F].ctrlOptions[H])}}}}else{if(e.isPlainObject(u.columns[F].ctrlOptions)){for(var H in u.columns[F].ctrlOptions){s.options[s.options.length]=new Option(u.columns[F].ctrlOptions[H],H)}}else{if(typeof(u.columns[F].ctrlOptions)=="string"){var C=u.columns[F].ctrlOptions.split(";");for(var H=0;H<C.length;H++){var J=C[H].indexOf(":");if(-1==J){s.options[s.options.length]=new Option(C[H],C[H])}else{s.options[s.options.length]=new Option(C[H].substring(J+1,C[H].length),C[H].substring(0,J))}}}}}tbCell.appendChild(s)}else{if(u.columns[F].type=="checkbox"){s=document.createElement("input");s.id=u.idPrefix+"_"+u.columns[F].name+"_"+D;s.name=s.id;s.type="checkbox";s.value=1;tbCell.appendChild(s);tbCell.style.textAlign="center"}else{s=document.createElement("input");s.id=u.idPrefix+"_"+u.columns[F].name+"_"+D;s.name=s.id;tbCell.appendChild(s);if(u.columns[F].type=="ui-datepicker"){e(s).datepicker(u.columns[F].uiOption)}else{if(u.columns[F].type=="ui-spinner"){e(s).spinner(u.columns[F].uiOption)}else{if(u.columns[F].type=="ui-autocomplete"){e(s).autocomplete(u.columns[F].uiOption)}}}}}}if(u.columns[F].type!="custom"){if(u.columns[F].ctrlAttr!=null){e(s).attr(u.columns[F].ctrlAttr)}if(u.columns[F].ctrlCss!=null){e(s).css(u.columns[F].ctrlCss)}if(u.columns[F].ctrlClass!=null){e(s).addClass(u.columns[F].ctrlClass)}if(u.columns[F].uiTooltip){e(s).tooltip(u.columns[F].uiTooltip)}if(typeof(u.columns[F].onClick)=="function"){e(s).click({caller:A,callback:u.columns[F].onClick,uniqueIndex:D},function(x){x.data.callback(x,e(x.data.caller).appendGrid("getRowIndex",x.data.uniqueIndex))})}if(typeof(u.columns[F].onChange)=="function"){e(s).change({caller:A,callback:u.columns[F].onChange,uniqueIndex:D},function(x){x.data.callback(x,e(x.data.caller).appendGrid("getRowIndex",x.data.uniqueIndex))})}}if(!k(u.columns[F].value)){l(u,F,D,u.columns[F].value)}}tbCell=tbRow.insertCell(-1);tbCell.className="ui-widget-content last";e(tbCell).append(e("<button/>").addClass("insert").val(D).attr({id:u.idPrefix+"_Insert_"+D,type:"button",title:u.textResources.insert,tabindex:-1}).button({icons:{primary:"ui-icon-arrowreturnthick-1-w"},text:false}).click(function(){e(A).appendGrid("insertRow",1,null,this.value)}));e(tbCell).append(e("<button/>").addClass("delete").val(D).attr({id:u.idPrefix+"_Delete_"+D,type:"button",title:u.textResources.remove,tabindex:-1}).button({icons:{primary:"ui-icon-trash"},text:false}).click(function(){g(A,null,this.value,false)}));e(tbCell).append(e("<button/>").addClass("moveUp").val(D).attr({id:u.idPrefix+"_MoveUp_"+D,type:"button",title:u.textResources.moveUp,tabindex:-1}).button({icons:{primary:"ui-icon-arrowthick-1-n"},text:false}).click(function(){e(A).appendGrid("moveUpRow",null,this.value)}));e(tbCell).append(e("<button/>").addClass("moveDown").val(D).attr({id:u.idPrefix+"_MoveDown_"+D,type:"button",title:u.textResources.moveDown,tabindex:-1}).button({icons:{primary:"ui-icon-arrowthick-1-s"},text:false}).click(function(){e(A).appendGrid("moveDownRow",null,this.value)}));for(var F=0;F<w.length;F++){s=document.createElement("input");s.id=u.idPrefix+"_"+u.columns[w[F]].name+"_"+D;s.type="hidden";tbCell.appendChild(s)}}b(A,u);if(e.isNumeric(G)){if(typeof(u.afterRowInserted)=="function"){u.afterRowInserted(A,v,L)}}else{if(typeof(u.afterRowAppended)=="function"){u.afterRowAppended(A,v,L)}}return{addedRows:L,parentIndex:v,rowIndex:G}}function g(t,y,s,v){var u=e(t).data("appendGrid");var x=t.getElementsByTagName("tbody")[0];if(e.isNumeric(s)){for(var w=0;w<u._rowOrder.length;w++){if(u._rowOrder[w]==s){y=w;break}}}if(e.isNumeric(y)){if(v||typeof(u.beforeRowRemove)!="function"||u.beforeRowRemove(t,y)){u._rowOrder.splice(y,1);x.deleteRow(y);b(t,u);n(t,y);if(typeof(u.afterRowRemoved)=="function"){u.afterRowRemoved(t,y)}}}else{if(v||typeof(u.beforeRowRemove)!="function"||u.beforeRowRemove(t,u._rowOrder.length-1)){s=u._rowOrder.pop();x.deleteRow(-1);b(t,u);if(typeof(u.afterRowRemoved)=="function"){u.afterRowRemoved(t,null)}}}}function n(s,v){var t=e(s).data("appendGrid");for(var u=v;u<t._rowOrder.length;u++){e("#"+t.idPrefix+"_Row_"+t._rowOrder[u]+" td.first",s).text(u+1)}}function a(y,u,x){var C,w,t,z,B;var v=e(y).data("appendGrid");if(v){C=y.getElementsByTagName("tbody")[0];e(C).empty();v._rowOrder.length=0;v._uniqueIndex=0;if(u!=null&&u.length){B=d(y,u.length,null,null);for(var s=0;s<B.addedRows.length;s++){for(var A=0;A<v.columns.length;A++){l(v,A,v._rowOrder[s],u[s][v.columns[A].name])}}}v._isDataLoaded=true;if(x){v.initData=null}e(y).data("appendGrid",v);if(typeof(v.dataLoaded)=="function"){v.dataLoaded(y)}}}function f(s,t){for(var u=0;u<t._rowOrder.length;u++){if(t._rowOrder[u]==s){return u}}return null}function k(s){return typeof(s)=="undefined"||s==null}function q(t,s){if(!k(t)&&e.isPlainObject(t)&&!k(t[s])){return t[s]}return null}function b(s,t){e(s).data("appendGrid",t);e("#"+t.idPrefix+"_rowOrder",s).val(t._rowOrder.join())}function r(t,s){var v=null;for(var u=0;u<t._rowOrder.length;u++){if(t._rowOrder[u]==s){return u}}return v}function h(v,t,x){var s={},u=null;for(var w=0;w<v.columns.length;w++){u=v.columns[w].name+(k(x)?"":"_"+x);s[u]=c(v,w,t)}return s}function c(w,u,s){var x=null,v=w.columns[u].type,t=w.columns[u].name;if(v=="checkbox"){x=p(v,w.idPrefix,t,s);if(x==null){return null}else{return x.checked?1:0}}else{if(v=="custom"){if(typeof(w.columns[u].customGetter)=="function"){return w.columns[u].customGetter(w.idPrefix,t,s)}else{return null}}else{x=p(v,w.idPrefix,t,s);if(x==null){return null}else{return x.value}}}}function p(u,v,t,s){return document.getElementById(v+"_"+t+"_"+s)}function l(w,u,s,x){var v=w.columns[u].type;var t=w.columns[u].name;if(v=="checkbox"){p(v,w.idPrefix,t,s).checked=(x!=null&&x!=0)}else{if(v=="custom"){if(typeof(w.columns[u].customSetter)=="function"){w.columns[u].customSetter(w.idPrefix,t,s,x)}}else{p(v,w.idPrefix,t,s).value=(x==null?"":x)}}}e.fn.appendGrid=function(s){if(i[s]){return i[s].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof(s)==="object"||!s){return i.init.apply(this,arguments)}else{e.error("`"+s+"` method does not supported by appendGrid...")}}}})(jQuery);